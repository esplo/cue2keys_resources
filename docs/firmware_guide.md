# ファームウェアガイド

このページでは、くっつきーのファームウェア（デバイスを制御するソフトウェア）に関する解説を行います。

キーボードとしての機能は、ペンダントモジュールに書き込まれたファームウェアによって実現しています。
挙動を変更したいときや動作に問題があるときは、ファームウェアを更新することで解決できる場合があります。

## 現行ファームウェア

ビルド済み（すぐに使える状態）のファームウェアは以下のリンクからダウンロードできます。
通常のユーザーは、こちらをダウンロードして[ファームウェアの書き込み方法](#ファームウェアの書き込み方法)を参照してください。

[ビルド済みファームウェア](../firmware/cue2keys_latest.uf2)

ソースコードは[esplo/cue2keys_firmwareのvia-enabledブランチ](https://github.com/esplo/cue2keys_firmware/tree/via-enabled)で公開しています。プログラミングの知識がある方は、フォークして自由に変更することもできます。

なお、現在書き込まれているファームウェアのバージョンは、ディスプレイの最後のページに表示されます。

### 主な機能

- QMK/VIAによるキーリマップ対応
  - キーボードの配列を自由に変更できます
- 8レイヤーに対応
  - 複数の機能を切り替えて使用できます
  - 必要に応じてさらに増やすことも可能です
- ディスプレイへの情報表示
  - ペンダントのボタンか、カスタムキーコード（`NEXT_OLED_PAGE`）を押すことでページが切り替わります

### トラックボール関連機能

- トラックボールの自動スリープ機能
  - デフォルトでは5分間使用しないと消灯します
  - キーを押したり、ロータリーエンコーダーを回すと再び点灯し、反応するようになります
- トラックボール使用中のマウスレイヤー自動切替機能
  - トラックボールを動かしている間、マウスレイヤーが自動的に有効になります
  - デフォルトのキーマップでは、レイヤー3がマウスレイヤーとして設定されており、左右クリックなどが割り当てられています

### カスタムキーコード

カスタムキーコード（特殊な機能を持つキー）についての詳細は[カスタムキーコードの説明](./custom_keycodes.md)で確認できます。

主な機能は以下の通りです：

- トラックボールの角度調整
  - 左右それぞれのトラックボールの角度を1°単位または30°単位で調整可能
- 自動マウスレイヤーのオフ遅延時間調整
  - トラックボールを止めてから自動マウスレイヤーが無効になるまでの時間を調整できます
  - 100ms（ミリ秒）単位で調整可能（デフォルトは1300ms）
- トラックボールの移動速度調整
  - 0.25倍単位で調整可能（デフォルトは1.0倍）
- ドラッグスクロール機能
  - 特定のキーを押している間、トラックボールの動きがスクロール操作になります
  - スクロール速度や方向も調整可能
- トラックボールLEDの消灯タイムアウト設定
  - 「なし」「5分」「10分」「15分」から選択可能（デフォルトは5分）
- ロータリーエンコーダーの解像度調整
  - 各エンコーダーの感度を調整可能

## ファームウェアの書き込み方法

ペンダントモジュールにファームウェアを書き込むには、まずブートローダー（初期起動プログラム）を起動する必要があります。
ブートローダーモードでは、キーを入力しても反応しなくなりますので注意してください。
書き込み作業時は、別のキーボードを接続するか、ノートPCの内蔵キーボードでの操作をおすすめします。

ブートローダーを起動する方法はいくつかあります：

- **（おすすめ）ペンダントのRSTボタンをダブルクリックする**
  - ゆっくりと2回押します（クリップなど細いピンで押すことができます）
- PCと接続しているケーブルを抜き、ペンダントのBSボタンを押しながら接続する
- `QK_BOOT`キーをキーマップに割り当てておき、それを押す
  - 頻繁にファームウェアを更新する場合におすすめです

ブートローダーモードになると、PCからは`RPI_RP2`という名前の外部ストレージとして認識されます。
そこに先ほどダウンロードしたファームウェア（`.uf2`拡張子のファイル）をコピー＆ペーストするだけで書き込みが行われます。
書き込み中は、ペンダント右上のLEDが点滅します。

書き込みが完了すると、自動的に接続が解除され、再接続されます。
通常は書き込みから約10秒程度で自動的に再認識（再接続）されますが、うまく認識されない場合は、PCとの接続ケーブルを抜き差しして手動でリセットしてください。

## コードからビルド（上級者向け）

上記に記載の通り、ソースコードは公開されています。
プログラミングの知識がある方は、既存のコードを元に自分だけの機能を追加してみることも可能です。

QMKファームウェアの詳細な解説は、スペースの都合上ここでは省略します。
他のQMKファームウェアと同様の方法で開発を行ってください。

## 設定値をリセットする

**⚠️ 注意**: リセットを行うとREMAPでの設定もクリアされます。キーマッピングを保存したい場合は、REMAPにログインして保存してからこの手順を行ってください。
ファームウェアの更新内容によっては、REMAPの設定が引き継げない場合もあります。あらかじめご了承ください。

カスタムキーコードによる設定（ディスプレイの2ページ目以降で確認できる値）は、ペンダントモジュール内のEEPROM（不揮発性メモリ）に保存されています。
ファームウェアの大幅な更新時には、これをクリアして再設定する必要がある場合があります。

[キーマップガイド](./keymap_guide.md)に従い、`DEVICE`タブにある`KEYBOARD`カテゴリから、`Clear EEPROM`というキーコードをいずれかのキーに割り当ててください。
スターターセットの初期設定では、以下の操作でこの機能を実行できるようにマッピングされています：
1. 左手側の左下のキーを押す
2. その右隣のキーを押す
3. 左上から2つ目のキー（レイヤー2のTab）を押す

リセット後は設定が初期値に戻りますので、必要な設定を改めて行ってください。
