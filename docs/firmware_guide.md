# ファームウェアガイド

このページでは、ファームウェアに関する解説を行います。

キーボードとしての機能は、ペンダントモジュールに書き込まれたファームウェアが実現しています。
挙動を変更したいとき、動作に問題があるときは、ファームウェアを変更してみましょう。

## 現行ファームウェア

ビルド済みのファームウェアはこちらです。
通常のユーザーは、こちらをダウンロードして[ファームウェアの書き込み方法](#ファームウェアの書き込み方法)を確認ください。

[ビルド済みファームウェア](../firmware/cue2keys_latest.uf2)

コードは[esplo/cue2keys_firmwareのvia-enabledブランチ](https://github.com/esplo/cue2keys_firmware/tree/via-enabled)で公開していますので、詳しい方はforkして変更してみてください。


### 主な機能

- QMK/VIAによるキーリマップ対応
- 8レイヤーに対応
  - 更に必要であれば増やせます
- ディスプレイへの情報表示
  - ペンダントのボタン、またはカスタムキーコード（`NEXT_OLED_PAGE`）を押すことでページが変わります

### トラックボール関連

- トラックボールの自動スリープ
  - デフォルトでは5分で消灯します。キーを押したり、ロータリーエンコーダーを触ると起動します
- トラックボールを動かしている間、マウスレイヤーが有効になる
  - デフォルトのキーマップでは、レイヤー3が有効になります。左右クリックなどが割り当てられています

### カスタムキーコード

- トラックボールの角度調整（`ROT_*`）
  - 2°単位での調整が可能
- トラックボールを止めてから何秒間マウスレイヤーを有効にし続けるかを調整（`MOUSE_LAYER_MS_*_50MS`）
  - 50ms単位、250msから1000msまで設定可能
- トラックボールの移動速度調整（`POINTER_SPEED_MAG_CHANGE`）
  - 1.0x (デフォルト) -> 2.0x -> 4.0x -> 0.5x と、4段階で倍率が変わる

## ファームウェアの書き込み方法

ペンダントモジュールにファームウェアを書き込むには、ブートローダーを起動する必要があります。
この状態では、キーを入力しても反応しなくなるので注意しましょう。
状況に応じて、別のキーボードを繋いだり、ノートPCでの作業が必要です。

ブートローダーを起動するには、いくつかの方法があります。

- （おすすめ）ペンダントのRSTボタンをダブルクリックする
  - ゆっくりと二回押します。クリップなど、細いピンで押すことができます
- PCと接続しているケーブルを抜き、ペンダントのBSボタンを押しながら接続する
- `QK_BOOT`キーをマッピングしておき、それを押す
  - 頻繁に書き込む場合におすすめです

ブートローダーに入ると、PCからは`RPI_RP2`という名前の外部ストレージとして認識されます。
そこにファームウェア（`.uf2`ファイル）を置くことで、書き込みが行われます。
書き込み中は、ペンd何と右上のLEDがピカピカします。

完了すると、自動的に接続が解除され、再度認識されます。
通常、書き込みから10秒程度で自動で再認識（再接続）されますが、うまく認識しない場合は、PCと接続しているケーブルを抜き差ししてリセットしてください。

## コードからビルドする

上記に記載の通り、必要なコードは全て公開されています。
既存のコードを元にして、好きな機能を追加してみましょう。

余白が足りないため、ここではQMKの解説は記載しません。
他のQMKファームウェアと同様の方法で開発を行ってください。

## 設定値をリセットする

**⚠️ 注意**: REMAPの設定もクリアされます。キーマッピングを保存したい方は、REMAPでログインして保存してからこの手順を行ってください。

カスタムキーコードによる設定（ディスプレイの2ページ目で確認できる値）は、ペンダントモジュールに記録されています。
ファームウェアの更新によっては、これをクリアして再設定する必要があります。

[キーマップガイド](./keymap_guide.md)に従い、`DEVICE`タブにある`KEYBOARD`カテゴリから、`Clear EEPROM`というキーコードをどこかのキーにマッピングします。
スターターセットでは、左手側の左下を押し、その右のキーを押してから、左上から2つ目のキー（レイヤー2のTab）を押したキーにマッピングしています。

設定が初期値になるので、お手数ですが改めて設定ください。
